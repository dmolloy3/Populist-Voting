---
title: "Party Graphs"
author: "Declan Molloy"
date: "08/04/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, dev = "png", dpi = 300, 
                      fig.width = 6, fig.asp = 0.618, fig.align = "center", out.width = "70%")
options(knitr.table.format = "html")
```

```{r packages, include=FALSE}
library(tidyverse)
library(haven)
library(ggrepel)
library(hrbrthemes)
library(modelr)
library(kableExtra)
```

#Identifying Populist Parties

There are two main datasets that attempt to classify parties around the world on various metrics, the Chapel Hill Expert Survey (CHES) and the Manifesto Project (previously known as the Comparative Manifesto Project). Neither explicitly code for populism, and so the challenge is to figure out a way to use the variables they do measure to try and come up with a systematic way to classify a party as populist or not. 

##Chapel Hill Expert Survey

To begin with, we'll look at the CHES dataset, which has asked country experts to rate various parties on different metrics. Inglehart and Norris have found that 13 variables from CHES neatly correspond to two separate cleavages: four can be reduced to an economic cleavage and nine can be reduced to a cultural cleavage. The variables summed to create the populism factor have been chosen to closely reflect ideological leanings associated with right wing populism. The results for every party is plotted below on both economic and populist scales, with parties classified as populist coloured in red, corresponding to higher cultural cleavage scores.

```{r parties, include=FALSE}
manifesto <- read_dta("data/MPDataset_MPDS2017a_stata14.dta")
parlgov.party <- read_csv("data/parlgov_party.csv")
ches.2014 <- read_dta("data/2014_CHES_dataset_means.dta") %>%
  mutate(party = party_name, year = 2014)
ches <- read_dta("data/1999-2014_CHES_dataset_means.dta") 
missing <- anti_join(ches.2014, ches, by = "party_id") %>% pull(party_id)
ches.combined <- bind_rows(ches, ches.2014 %>% filter(party_id %in% missing)) %>%
  rename(country.code = country) %>%
  mutate(country = case_when(country.code == 1 ~ "Belgium", 
                             country.code == 2 ~ "Denmark",
                             country.code == 3 ~ "Germany",
                             country.code == 4 ~ "Greece",
                             country.code == 5 ~ "Spain", 
                             country.code == 6 ~ "France",
                             country.code == 7 ~ "Ireland",
                             country.code == 8 ~ "Italy",
                             country.code == 10 ~ "Netherlands", 
                             country.code == 11 ~ "UK",
                             country.code == 12 ~ "Portugal",
                             country.code == 13 ~ "Austria",
                             country.code == 14 ~ "Finland", 
                             country.code == 16 ~ "Sweden",
                             country.code == 20 ~ "Bulgaria",
                             country.code == 21 ~ "Czech Republic",
                             country.code == 22 ~ "Estonia",
                             country.code == 23 ~ "Hungary",
                             country.code == 24 ~ "Latvia",
                             country.code == 25 ~ "Lithuania",
                             country.code == 26 ~ "Poland",
                             country.code == 27 ~ "Romania",
                             country.code == 28 ~ "Slovakia",
                             country.code == 29 ~ "Slovenia",
                             country.code == 31 ~ "Croatia",
                             country.code == 34 ~ "Turkey",
                             country.code == 35 ~ "Norway",
                             country.code == 36 ~ "Switzerland",
                             country.code == 37 ~ "Malta",
                             country.code == 38 ~ "Luxembourg",
                             country.code == 40 ~ "Cyprus")) 
party.link <- read_dta("data/link file for parties in EES.dta", encoding='latin1')
```
```{r party cross ref, include=FALSE}
# Manifesto ---------------------------------------------------------------
manifesto.unique <- manifesto %>%
  group_by(party) %>% 
  slice(which.max(edate)) %>%
  dplyr::ungroup() %>%
  mutate(cmp = party) %>%
  mutate(cmp = as.integer(cmp))

ches.unique <- ches.combined %>%
  select(country, eastwest, eumember, year, ches.id = party_id, cmp.id = cmp_id, party, vote, seat, electionyear, family, govt, 
         galtan, sociallifestyle, nationalism, civlib_laworder, multiculturalism, immigrate_policy, ethnic_minorities, religious_principle, urban_rural, 
         deregulation, econ_interven, redistribution, spendvtax) %>%
  #filter(year > 2005) %>%
  mutate(pop.mean = (rowMeans(select(., galtan, sociallifestyle, nationalism, 
                                     civlib_laworder, multiculturalism, immigrate_policy, 
                                     ethnic_minorities, religious_principle, urban_rural), na.rm = TRUE)) * 10,
         eco.mean = (rowMeans(select(., deregulation, econ_interven, redistribution, spendvtax), na.rm = TRUE)) * 10,
         pop.vote = if_else(pop.mean >= 75.35, 1, 0)) %>%
  group_by(ches.id) %>% 
  slice(which.max(year)) %>%
  dplyr::ungroup() %>%
  mutate(cmp.id = case_when(ches.id == 308 ~ 41521,
                            ches.id == 411 ~ 34020,
                            ches.id == 518 ~ 33096,
                            ches.id == 709 ~ 53021,
                            ches.id == 807 ~ 32221,
                            ches.id == 819 ~ 32421,
                            ches.id == 832 ~ 32329,
                            ches.id == 839 ~ 32320,
                            ches.id == 844 ~ 32630,
                            ches.id == 1107 ~ 51110,
                            ches.id == 2005 ~ 80062,
                            ches.id == 2012 ~ 80620,
                            ches.id == 2013 ~ 80061,
                            ches.id == 2014 ~ 80062,
                            ches.id == 2015 ~ 80630,
                            ches.id == 2016 ~ 80330,
                            ches.id == 2205 ~ 83952,
                            ches.id == 2410 ~ 87340,
                            ches.id == 2411 ~ 87620,
                            ches.id == 2412 ~ 87062,
                            ches.id == 2413 ~ 87630,
                            ches.id == 2414 ~ 87901,
                            ches.id == 2517 ~ 88630,
                            ches.id == 2611 ~ 92021,
                            ches.id == 2702 ~ 93031,
                            ches.id == 2709 ~ 93031, 
                            
                            TRUE ~ as.numeric(cmp.id))) %>%
  select(country, year, electionyear, party, ches = ches.id, cmp = cmp.id, vote, pop.mean, eco.mean, pop.vote) %>%
  mutate(ches = as.integer(ches), 
         cmp = as.integer(cmp))

parlgov.party.unique <- parlgov.party %>% 
  select(country_name, party_name_short, party_name_english, party_name, cmp, ches = chess, parlgov = party_id) %>%
  filter(!is.na(cmp)) %>% 
  arrange(ches) %>% 
  distinct(cmp, .keep_all = TRUE)

parlgov.unique.ches <- parlgov.party %>% 
  select(country_name, party_name_short, party_name_english, party_name, cmp, ches = chess, parlgov = party_id) %>%
  filter(!is.na(ches)) %>% 
  arrange(cmp) %>%
  distinct(ches, .keep_all = TRUE)

ches.parl <- left_join(ches.unique, parlgov.unique.ches, by = "ches") %>%
  mutate(cmp = if_else(is.na(cmp.x), cmp.y, cmp.x)) %>%
  select(-c(cmp.x, cmp.y))

ches.filter.na <- ches.parl %>% 
  filter(!(ches == 308 | ches == 411 | ches == 2005 | ches == 2709 | ches == 3113)) %>%
  filter(!is.na(cmp))

first.join <- left_join(manifesto.unique, ches.filter.na, by = "cmp")

doubled.up <- first.join %>% count(ches) %>% filter(n>1) %>% filter(!(is.na(ches))) %>% pull(ches)

second.join1 <- first.join %>%
  filter(!(ches %in% doubled.up))

temp.second.join <- first.join %>%
  filter(ches %in% doubled.up) %>%
  group_by(ches) %>%
  fill(parlgov) %>% fill(parlgov, .direction = "up") %>%
  ungroup()

third.join <- bind_rows(second.join1, temp.second.join)

party.link.unique <- party.link %>%
  select(country, prty_code, cmp = eu_manifesto, party_name) %>%
  filter(!is.na(cmp)) %>%
  distinct(cmp, .keep_all = TRUE) %>%
  mutate(cmp = as.integer(cmp))

manifesto.extended <- left_join(third.join, party.link.unique, by = "cmp") %>%
  mutate(state.market = (per401 + per402 + per407 + per414 + per505) - (per403 + per404 + per405 + per406 + per409 + per412 + per413 + per415 + per416 + per504), 
         prog.con = (per104 + per109 + per601 + per603 + per605 + per608) - (per105 + per106 + per107 + per501 + per503 + per602 + per604 + per607 + per705), 
         eco.lr = (per303 + per401 + per402 + per407 + per414 + per505 + per702 + per704) - (per404 + per406 + per413 + per415 + per503 + per504 + per701), 
         lib.auth = (per104 + per601 + per603 + per605 + per608) - (per105 + per602 + per604 + per607 + per705 + per416)) %>%
  select(country = countryname, party = partyname, partyabbrev, parfam, edate, edate.ches = electionyear, cmp, ches, parlgov,
         vote, pop.mean, pop.vote, prog.con, lib.auth, eco.mean, rile, state.market, eco.lr,planeco, markeco, welfare, per104, per601, per603, per605, per608, per105, per602, per604, per607, per705, per416) %>% 
  mutate(pop.cmp = 50 + (lib.auth/2)) %>%
  mutate(partyabbrev = if_else(cmp == 87630, "NSL", partyabbrev))

#corrplot(cor(manifesto.extended %>% select(-c(country, party, partyabbrev, edate, edate.ches, cmp, ches, parlgov, vote)), use = "complete.obs"), method = "circle")

# CHES --------------------------------------------------------------------

ches.extended <- ches.parl %>%
  left_join(manifesto.extended, by = "cmp") %>%
  select(country = country.x, year, electionyear, party_name_english, party_name, party.short = party.x, party.cmp = party.y, ches = ches.x, cmp, parlgov = parlgov.x, vote = vote.x, pop.mean = pop.mean.x, eco.mean = eco.mean.x, pop.vote = pop.vote.x, lib.auth, eco.lr) %>%
  filter(year > 2005)

rm(list=setdiff(ls(), c("manifesto.extended", "manifesto", "ches.combined", "ches.extended")))
``` 

```{r CHES-party-positions, fig.width=7, out.width = "100%", fig.asp = 1, cache = TRUE}
ggplot(data = ches.extended, aes(x = eco.mean, y = pop.mean, colour = factor(pop.vote))) + 
  geom_text_repel(aes(label = party.short), size = 1.8, box.padding = unit(0.1, 'lines'), point.padding = unit(.1, 'lines')) +
  geom_point(size = .005) + 
  coord_cartesian(ylim = c(0, 100), xlim = c(0, 100)) + 
  labs(x = "Left <<<< Economic Values Scale >>>> Right", 
       y = "Cosmopolitan Liberalism <<<< Cultural Values Scale >>>> Populism",
       colour = NULL, 
       caption = "Data from CHES 1999-2014") + 
  theme_ipsum() + theme(axis.title.x=element_text(hjust=.5), axis.title.y=element_text(hjust=.5)) + scale_color_brewer(labels =
                             c("Not Populist", "Populist"), palette = "Set1", direction=-1) +
  theme(legend.position = "top") + theme(plot.margin = unit(c(.35, .35, .35, .35), "cm"))
```

##Manifesto Project

A second large scale source of data on parties is the Manifesto Project which, as the name suggests, examines the electoral manifestos and other related materials of parties, coding based on how often certain topics are mentioned. Again, parties are plotted on an economic and populist scale. Parties have also been coloured according to whether they were previously classified as populist in the CHES dataset. As parties take a much smaller range of values and are thus more tightly clustered using the Manifesto project variables, it was not possible to label all of them. In order to highlight the differences in outcomes between the CHES and Manifesto Project results, political parties have been labelled that were classed as populist by the CHES data but scored lowly on the populist scale using the Manifesto Project data, as well as parties that scored highly but were not classified as populist by CHES. 

```{r cmp-parties, fig.width=7, out.width = "100%", cache = TRUE}
non.pop <- manifesto.extended %>% 
  filter(pop.vote == 0) %>%
  top_n(20, lib.auth) %>%
  pull(ches)

pop <- manifesto.extended %>% 
  filter(pop.vote == 1) %>%
  top_n(-10, lib.auth) %>% 
  pull(ches)

p <- ggplot(data = manifesto.extended %>% filter(!is.na(pop.vote)), aes(x = eco.lr, y = lib.auth, colour = factor(pop.vote)))
p + geom_point(size = .1) +
  geom_text_repel(data = subset(manifesto.extended, ches %in% non.pop | ches %in% pop), aes(label = partyabbrev), size = 2.8, box.padding = unit(0.1, 'lines'), point.padding = unit(.1, 'lines')) +
  labs(x = "Left <<<< Economic Values Scale >>>> Right", 
       y = "Cosmopolitan Liberalism <<<< Cultural Values Scale >>>> Populism",
       colour = "Classification from CHES") + 
  theme_ipsum() + theme(axis.title.x=element_text(hjust=.5), axis.title.y=element_text(hjust=.5)) + scale_color_brewer(labels =
                             c("Not Populist", "Populist"), palette = "Set1", direction=-1) +
  theme(legend.position = "top") + theme(plot.margin = unit(c(.35, .35, .35, .35), "cm"))
```

To further compare and contrast both datasets and methods, the Manifesto Project populist scores have been rescaled to a 0-100 scale, then each party plotted by their populist scores from the CHES data against the scores from the Manifesto data. Also included is a simple linear regression showing the relationship between the two scores, with some of the parties that have the highest absolute residuals from this linear regression labelled.

```{r compare, fig.width=7, out.width = "100%", cache = TRUE}
mod.compare <- lm(formula = pop.mean ~ pop.cmp, data = manifesto.extended)
grid <- manifesto.extended %>%
  data_grid(pop.cmp) %>%
  add_predictions(mod.compare)

manifesto.extended <- manifesto.extended %>%
  add_residuals(mod.compare)

p <- ggplot(manifesto.extended %>% filter(!is.na(pop.mean)), aes(x = pop.cmp, y = pop.mean))
p + geom_point(aes(colour = factor(pop.vote)), size = .1) + 
  geom_text_repel(data = subset(manifesto.extended, resid > 28 | resid < -25), aes(label = partyabbrev, colour = factor(pop.vote)), size = 3.5, box.padding = unit(0.1, 'lines'), point.padding = unit(.1, 'lines')) +
  geom_smooth(method = "lm") + 
  labs(x = "Manifesto Project - Populism score", 
       y = "CHES - Populism score",
       colour = "Classification from CHES") + 
  theme_ipsum() + theme(axis.title.x=element_text(hjust=.5), axis.title.y=element_text(hjust=.5)) + scale_color_brewer(labels =
                             c("Not Populist", "Populist"), palette = "Set1", direction=-1) +
  coord_cartesian(ylim = c(0, 100), xlim = c(35, 77.5)) + 
  theme(legend.position = "top") + theme(plot.margin = unit(c(.35, .35, .35, .35), "cm"))
```

Finally, I've plotted the residuals themselves, with the same parties labelled. Parties above 0 means a party's CHES populism score is higher (more populist) than expected given its score from the Manifesto Project.

```{r resid-compare, fig.width=7, out.width = "100%", cache = TRUE}
ggplot(manifesto.extended %>% filter(!is.na(pop.vote)), aes(pop.cmp, resid, colour = factor(pop.vote))) + 
  geom_ref_line(h = 0, colour = "gray70") +
  geom_point(size = .1) +
  geom_text_repel(data = subset(manifesto.extended, resid > 28 | resid < -25), aes(label = partyabbrev), size = 3.5, box.padding = unit(0.1, 'lines'), point.padding = unit(.1, 'lines')) + 
  labs(x = "Manifesto Project - Populism score", 
       y = "Residual error",
       colour = "Classification from CHES") + 
  theme_ipsum() + theme(axis.title.x=element_text(hjust=.5), axis.title.y=element_text(hjust=.5)) + scale_color_brewer(labels =
                             c("Not Populist", "Populist"), palette = "Set1", direction=-1) +
  theme(legend.position = "top") + theme(plot.margin = unit(c(.35, .35, .35, .35), "cm"))
```

##Which to use?

Looking at these comparisons, it becomes clear that the Manifesto Project populism score is worse at identifying populist radical right parties than the CHES score. The plot of its party classifications shows several widely accepted populist parties, including *Ataka* in Bulgaria, *AfD* in Germany and *Lega Nord* in Italy, with populist scores close to the mean of all parties. This difference is even more stark in when we look at the residuals, where we can see that the parties rated higher by CHES include other populist parties, such as *Jobbik* in Hungary and the *People's Party – Dan Diaconescu* in Romania. Parties that are rated as higher by the Manifesto Project metric include more left-leaning parties, such as the *Left Bloc* in Portugal and the *Green Party* in Sweden. Given this project is focused on radical right populist parties, I use the CHES data to classify populist parties. See below for a full table. 

```{r ches-table, cache=TRUE}
ches.tbl <- ches.extended %>%
  mutate(party.name = if_else(!is.na(party_name_english), party_name_english, party.cmp)) %>%
  filter(pop.vote == 1) %>%
  arrange(country) %>%
  mutate(party.name = if_else(party.short == "VMRO-BND", "Bulgarian National Movement", party.name),
         party.name = if_else(party.short == "NFSB", "National Front for the Salvation of Bulgaria", party.name),
         party.name = if_else(party.short == "HSP-AS", "Croatian Party of Rights – Dr. Ante Starcevic", party.name),
         party.name = if_else(party.short == "SP", "United Poland", party.name),
         party.name = if_else(party.short == "KNP", "Congress of the New Right", party.name)) %>%
  mutate_if(is.numeric, funs(round(., 2))) %>%
  select(Country = country, "CHES Wave" = year, "Party Abbreviation" = party.short, "Party Name in English" = party.name, "Election Year" = electionyear, "Vote Share" = vote, "Economic Scale" = eco.mean, "Populism Scale" = pop.mean)
knitr::kable(
  ches.tbl, 
  caption = "Classification of Parties", 
  booktabs = T
)
```
